# Stage 1: Build with Gradle
FROM gradle:jdk21-jammy AS builder
WORKDIR /workspace

# 1. Copy Gradle wrapper first (rarely changes)
COPY gradle/ gradle/
COPY gradlew gradlew.bat ./

# 2. Copy Gradle config files
COPY gradle.properties settings.gradle ./

# 3. Download Gradle
RUN ./gradlew --version --no-daemon

COPY --chown=gradle:gradle ./app .

# Run the builder w/ the secret
RUN ./gradlew buildLayers --no-daemon

# Stage 2: Create the final image
FROM eclipse-temurin:21-jre-jammy

WORKDIR /home/app

COPY --from=builder /workspace/build/docker/main/layers/libs /home/app/libs
COPY --from=builder /workspace/build/docker/main/layers/classes /home/app/classes
COPY --from=builder /workspace/build/docker/main/layers/resources /home/app/resources
COPY --from=builder /workspace/build/docker/main/layers/application.jar /home/app/application.jar

RUN useradd -u 8877 unity
# Change to non-root privilege
USER unity

EXPOSE 8080
ENTRYPOINT ["java", "-jar", "/home/app/application.jar"]
