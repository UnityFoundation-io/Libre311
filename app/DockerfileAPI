# Stage 1: Build with Gradle
FROM gradle:9.1.0-jdk25 AS builder
WORKDIR /workspace

ARG DB_TYPE=mysql
ARG CLOUD_DB=false
ENV LIBRE311_DATABASE_TYPE=${DB_TYPE}
ENV LIBRE311_CLOUD_DB=${CLOUD_DB}

# 2. Copy Gradle config files
COPY app/gradle.properties app/settings.gradle ./

# 3. Download Gradle
RUN gradle --version --no-daemon

COPY --chown=gradle:gradle ./app .

# Run the builder w/ the secret
RUN gradle buildLayers --no-daemon

# Stage 2: Create the final image
FROM eclipse-temurin:25-jre

WORKDIR /home/app

# Micronaut 4.x layer structure
COPY --from=builder /workspace/build/docker/main/layers/libs /home/app/libs
COPY --from=builder /workspace/build/docker/main/layers/resources /home/app/resources
COPY --from=builder /workspace/build/docker/main/layers/app/application.jar /home/app/application.jar

RUN useradd -u 8877 unity
# Change to non-root privilege
USER unity

EXPOSE 8080
ENTRYPOINT ["java", "-jar", "/home/app/application.jar"]
